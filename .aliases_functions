### SHELL UTILITIES ####################################################################################################
alias reload='exec zsh'

alias choose="fzf --height 10"
alias fchoose="ls | choose"

# Check environment variables: shorthand or `env | grep i <foo>`. Redacts passwords and tokens.
cenv(){
    env | grep -i $1 |  \
    sed -E "s/(.*)PASSWORD=(.*)/\1PASSWORD=<redacted>/" | \
    sed -E "s/(.*)TOKEN=(.*)/\1TOKEN=<redacted>/"
}

# Unset env vars based on regex matching (case insensitive)
unsetall(){
    unset $(cenv $1 | awk -F "=" '{print $1}')
}

# Select dotfile to source from .rc directory
sl(){
    source $(find ~/.rc  -type f | choose)
}

# Shows definition of passed alias or function
define(){
    type $1
    declare -f $1 | bat -p --language sh || return 0 # declare only on functions, don't error out if $1 is an alias
}

# Copies select dotfiles to dotfiles repo on `menthol` server
copy-dotfiles() {
    # scp ~/{.aliases_functions,.gitconfig,.gitignore_global,.joris.omp.json,.utils.py,.zshrc,brew.sh} joris@menthol.local:~/repos/dotfiles
    
    # use /./ in rsync to tell rsync to copy the path from that point forward
    # Thanks sir! https://serverfault.com/a/973844/166001
    rsync --relative ~/./{.config/gh/config.yml,.env.sh,.aliases_functions,.gitconfig,.gitignore_global,.joris.omp.json,.utils.py,.zshrc,brew.sh,.vimrc} joris@menthol.local:~/repos/dotfiles
}

### PROGRAM OVERRIDES  #################################################################################################
alias cat='bat'  # https://github.com/sharkdp/bat
#alias find='fd' # https://github.com/sharkdp/fd
alias ls="lsd"   # https://github.com/Peltoche/lsdexport 

# Program aliases
alias excel="open -a 'Microsoft Excel'"
alias code="code-insiders"
alias vscode="code-insiders"

### DESK  ##############################################################################################################

# https://github.com/jamesob/desk
alias dl="desk list"
desk_choose(){
  desk list | choose | awk '{print $1}'
}
ds() { # Desk "switch"
  desk go $(desk_choose)
}
de(){
    code-insiders ~/.desk/desks/$(desk_choose).sh
}

### ANSIBLE  ###########################################################################################################
export ANSIBLE_VAULT_PASSWORD_FILE="~/.ansible-vault-password"

vault-get(){
    local VAULT="$(ansible-vault view ~/repos/casa-data/group_vars/all)"
    echo "$VAULT" | awk "/$1: /{print \$2}" | tr -d '\"'
}

vault-search(){
    local VAULT="$(ansible-vault view ~/repos/casa-data/group_vars/all)"
    echo "$VAULT" | grep "$1"
}

# Get host IP. Usage: ansible-host <hostname>
ansible-host(){
    ansible-inventory -i ~/repos/casa-data/inventory/prod --list | jq -r ."$1.hosts[0]"
}

# Get variable for a given host. Usage: ansible-inventory-get <host> <varname>
ansible-inventory-get(){
    ansible-inventory -i ~/repos/casa-data/inventory/prod --host $1 | jq -r .$2
}

### VAGRANT  ###########################################################################################################
alias v='vagrant'
alias vs='vagrant status'
alias vgs='vagrant global-status'
alias vss='vagrant ssh'
alias vup='vagrant up'
alias vssh='vagrant ssh'
#alias vd='vagrant destroy -f' # conflicts with visidata

### LDAP  ##############################################################################################################
lds(){
  ldapsearch -o ldif-wrap=no -H $LDAP_HOST -w $LDAP_PASSWORD -D $LDAP_BIND -b $LDAP_BASE_SEARCH $1
}

### Device42  ##########################################################################################################

d42get(){ 
    curl -s -k -u "$D42_USERNAME:$D42_PASSWORD" "$D42_BASE_URL$@"
}
d42post(){
    curl -s -k -u "$D42_USERNAME:$D42_PASSWORD" -X POST "$D42_BASE_URL$@"
}
d42put(){
    curl -s -k -u "$D42_USERNAME:$D42_PASSWORD"  -X PUT "$D42_BASE_URL$@"
}
d42delete(){
    curl -s -k -u "$D42_USERNAME:$D42_PASSWORD"  -X DELETE "$D42_BASE_URL$@"
}

### DATA WRANGLING  ####################################################################################################
# _u: call .utils.py and pass all arguments
# .utils.py is a python script that contains functions for data wrangling
# While some of these could be written as pure shell functions, python makes many functions simpler and portable across
# shells.

alias _u="python ~/.utils.py"

# help: print all messages
alias _h="_u h"
# trim: remove whitespace from the beginning and end of a string
alias trim="_u trim"
# trimnl: remove empty newlines from stdin
alias trimnl="_u trimnl"
# lower: convert all characters to lowercase
alias lower="_u lower"
# upper: convert all characters to uppercase
alias upper="_u upper"
# prune: remove all occurences that occur in a specified list (specified via file) from STDIN
alias prune="_u prune"
# prunestr: "prune string": remove all passed strings from STDIN
alias prunestr="_u prunestr"
# join: join all lines in STDIN with a specified delimiter
alias join="_u join"

# split: split STDIN into lines with a specified delimiter
alias split="_u split"
# Replace whitespace with newlines
alias wsplit="_u wsplit"

alias prepend="_u prepend"
alias append="_u append"
alias wrap="_u wrap"
alias noop="_u noop"


# stats() {
#   echo "Lines Count: $(wc -l | trim)"
#   echo "Unique Lines: $(sort | uniq | wc -l | trim)"
# }

# Show frequency table
frequency() {
    sort | uniq -c | sort -nr | trim
}

# default: returns a default value if STDIN is empty, otherwise return STDIN
default() {
    grep . || echo $1
    #  awk '{print ($0 == "" ? "'$1'" : $0)}'
}

### SCRATCHPAD #########################################################################################################
alias sc="cat /tmp/scratchpad.txt"
alias scn="pbpaste > /tmp/scratchpad.txt;sc"
alias sce="code /tmp/scratchpad.txt"

### DIFF ###############################################################################################################
ldiff(){
    _u linecompare $1 $2 | less -SR
}